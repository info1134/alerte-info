<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>INFO11 â€” Alerte Info Locale - Aude</title>
  <!-- Bootstrap CSS CDN -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <!-- Font Awesome pour icÃ´nes -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" rel="stylesheet" />

  <style>
    body {
      max-width: 700px;
      margin: 2rem auto;
      font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      background: #f8f9fa;
      color: #212529;
    }
    h1, h2 {
      text-align: center;
      margin-bottom: 1.8rem;
      font-weight: 700;
      color: #343a40;
    }
    form {
      background: white;
      padding: 2rem;
      border-radius: 12px;
      box-shadow: 0 6px 20px rgba(0,0,0,0.1);
      margin-bottom: 2rem;
      transition: box-shadow 0.3s ease;
    }
    form:hover {
      box-shadow: 0 10px 35px rgba(0,0,0,0.15);
    }
    #message {
      margin-bottom: 1rem;
      font-weight: 600;
      font-size: 1.1em;
      min-height: 1.5em;
      text-align: center;
    }
    #alert-list li {
      background: white;
      border-radius: 8px;
      padding: 1rem 1.2rem;
      margin-bottom: 1rem;
      box-shadow: 0 3px 12px rgba(0,0,0,0.08);
      transition: transform 0.25s ease, box-shadow 0.25s ease;
      cursor: default;
    }
    #alert-list li:hover {
      transform: translateY(-4px);
      box-shadow: 0 10px 30px rgba(0,0,0,0.12);
    }
    .btn-animated {
      transition: transform 0.15s, box-shadow 0.15s;
    }
    .btn-animated:hover, .btn-animated:focus {
      transform: scale(1.1) rotate(-3deg);
      box-shadow: 0 6px 25px rgba(13, 110, 253, 0.5);
    }
    .btn-animated:active {
      transform: scale(0.95);
      box-shadow: 0 3px 12px rgba(13, 110, 253, 0.3);
    }
    .alert-ok {
      color: #198754;
    }
    .alert-error {
      color: #dc3545;
    }
  </style>
</head>
<body>
  <h1><i class="fas fa-bullhorn"></i> INFO11 â€” Les alertes publiÃ©es dans lâ€™Aude</h1>
  <form id="alert-form" class="needs-validation" novalidate>
    <div class="mb-3">
      <label for="lieu" class="form-label"><i class="fas fa-map-marker-alt me-2"></i>Commune</label>
      <select class="form-select" id="lieu" name="lieu" required>
        <option value="" selected disabled>-- Choisir une commune --</option>
        <option>Carcassonne</option>
        <option>Narbonne</option>
        <option>Limoux</option>
        <option>Leucate</option>
        <option>Castelnaudary</option>
        <option>Sigean</option>
        <option>Port-la-Nouvelle</option>
        <option>Gruissan</option>
        <option>EspÃ©raza</option>
        <option>Rieux-Minervois</option>
        <option>Armissan</option>
        <option>LÃ©zignan-CorbiÃ¨res</option>
        <option>Peyriac-de-Mer</option>
        <option>Moussan</option>
        <option>Palaja</option>
        <option>Montolieu</option>
        <option>PuichÃ©ric</option>
        <option>Capendu</option>
        <option>Alzonne</option>
        <option>Belpech</option>
        <option>Villemoustaussou</option>
        <option>TrÃ¨bes</option>
        <option>Bize-Minervois</option>
        <option>Saint-Nazaire-d'Aude</option>
        <option>Mirepeisset</option>
        <option>La Palme</option>
        <option>Roquefort-des-CorbiÃ¨res</option>
        <option>Ginestas</option>
        <option>Coursan</option>
        <option>Ouveillan</option>
      </select>
      <div class="invalid-feedback">Veuillez choisir une commune.</div>
    </div>

    <div class="mb-3">
      <label for="type" class="form-label"><i class="fas fa-exclamation-triangle me-2"></i>Type dâ€™Ã©vÃ©nement</label>
      <select class="form-select" id="type" name="type" required>
        <option value="" selected disabled>-- Choisir un type dâ€™Ã©vÃ©nement --</option>
        <option>ContrÃ´le de police</option>
        <option>Feu de forÃªt</option>
        <option>Accident</option>
        <option>Autre</option>
      </select>
      <div class="invalid-feedback">Veuillez choisir un type dâ€™Ã©vÃ©nement.</div>
    </div>

    <div class="mb-3">
      <label for="description" class="form-label"><i class="fas fa-pen-fancy me-2"></i>Description (optionnel)</label>
      <textarea class="form-control" id="description" name="description" rows="3" placeholder="Description supplÃ©mentaire..."></textarea>
    </div>

    <button type="submit" class="btn btn-primary btn-animated w-100">
      <i class="fas fa-flag me-2"></i>ðŸš© Publier lâ€™alerte
    </button>
  </form>

  <div id="message" role="alert"></div>
  <h2><i class="fas fa-list-alt me-2"></i>Les alertes publiÃ©es dans lâ€™Aude</h2>
  <ul id="alert-list" class="list-unstyled"></ul>

  <!-- Bootstrap JS Bundle (popper + bootstrap) -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    // Validation Bootstrap
    (() => {
      'use strict'
      const forms = document.querySelectorAll('.needs-validation')
      Array.from(forms).forEach(form => {
        form.addEventListener('submit', event => {
          if (!form.checkValidity()) {
            event.preventDefault()
            event.stopPropagation()
            form.classList.add('was-validated')
            return
          }
          event.preventDefault()
          envoyerAlerte()
        }, false)
      })
    })();

    const messageDiv = document.getElementById('message');
    const alertList = document.getElementById('alert-list');

    async function chargerAlertes() {
      alertList.innerHTML = '';
      try {
        const response = await fetch('/api/infos');
        if(!response.ok) throw new Error('Erreur chargement alertes');
        // SÃ©curitÃ© : ne parse en JSON que si la rÃ©ponse est du JSON pur
        const contentType = response.headers.get('content-type') || '';
        if (contentType.indexOf('application/json') === -1) {
          throw new Error("Le serveur ne renvoie pas du JSON.");
        }
        const data = await response.json();
        if (!Array.isArray(data) || data.length === 0) {
          alertList.innerHTML = '<li>Aucune alerte pour le moment.</li>';
          return;
        }
        data.forEach(info => {
          const li = document.createElement('li');
          li.innerHTML = `
            <strong><i class="fas fa-map-marker-alt"></i> ${info.lieu}</strong> â€” <em><i class="fas fa-exclamation-circle"></i> ${info.type}</em> 
            <br><small><i class="fas fa-clock"></i> ${new Date(info.date).toLocaleString()}</small>
            <br>${info.description ? info.description : ''}
          `;
          alertList.appendChild(li);
        });
      } catch (error) {
        alertList.innerHTML = '<li>Impossible de charger les alertes.</li>';
        console.error(error);
      }
    }

    async function envoyerAlerte() {
      const form = document.getElementById('alert-form');
      const data = {
        lieu: form.lieu.value,
        type: form.type.value,
        description: form.description.value.trim()
      };
      messageDiv.textContent = '';
      messageDiv.className = '';
      try {
        const response = await fetch('/api/infos', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify(data)
        });
        if (!response.ok) {
          let errText = await response.text();
          let errMsg = errText;
          try {
            const errData = JSON.parse(errText);
            errMsg = errData.error || errText;
          } catch (e) {}
          throw new Error(errMsg || 'Erreur lors de la publication');
        }
        messageDiv.textContent = 'âœ… Merci, votre alerte a bien Ã©tÃ© publiÃ©e !';
        messageDiv.classList.add('alert-ok');
        form.reset();
        form.classList.remove('was-validated');
        await chargerAlertes();
      } catch (error) {
        messageDiv.textContent = error.message;
        messageDiv.classList.add('alert-error');
      }
    }

    // Chargement initial des alertes
    chargerAlertes();
  </script>
</body>
</html>